// OPTIMIZED team_management/roster endpoint - V3
// Key fix: MUST ADD INDEX on transaction.transaction_owner_agent_id for performance
// Without index, query scans entire table causing timeout

query "team_management/roster" verb=GET {
  input {
    int team_id?
    text search? filters=trim
    text sortBy? filters=trim
    text orderBy? filters=trim
    bool is_director?
    bool is_leader?
    bool is_mentor?
    bool inactive?
    bool seat?
    bool seat_unassigned?
    int page?
    int per_page?
  }

  stack {
    db.query team_members {
      where = $db.team_members.team_id ==? $input.team_id && $db.team_members.is_director ==? $input.is_director && $db.team_members.is_leader ==? $input.is_leader && $db.team_members.is_mentor ==? $input.is_mentor && $db.team_members.seat ==? $input.seat && $db.team_members.active !=? $input.inactive
      sort = {team_members.id: "desc"}
      return = {type: "list"}
    } as $team_members

    var $agent_ids {
      value = $team_members|get:"agent_id":null
    }

    db.query agent {
      where = $db.agent.id in $agent_ids
      return = {type: "list"}
      output = [
        "id"
        "display_name"
        "first_name"
        "last_name"
        "email"
        "phone"
        "home_address_id"
        "city"
        "state"
      ]
    } as $agents

    var $address_ids {
      value = $agents
        |get:"home_address_id":null
        |unique:""
    }

    db.query address {
      where = $db.address.id in $address_ids
      return = {type: "list"}
      output = ["id", "city", "state", "state_abbreviation", "lat", "long"]
    } as $addresses

    // Get transactions for agents to use as fallback location
    // NOTE: This query needs an INDEX on transaction_owner_agent_id
    db.query transaction {
      where = $db.transaction.transaction_owner_agent_id in $agent_ids
      sort = {closing_date: "desc"}
      return = {type: "list"}
      output = ["id", "transaction_owner_agent_id", "address_id"]
    } as $agent_transactions

    // Get transaction addresses for fallback
    var $tx_address_ids {
      value = $agent_transactions|get:"address_id":null|unique:""
    }

    db.query address {
      where = $db.address.id in $tx_address_ids
      return = {type: "list"}
      output = ["id", "city", "state", "state_abbreviation", "lat", "long"]
    } as $tx_addresses

    var $roster_data {
      value = []
    }

    foreach ($team_members) {
      each as $member {
        array.find ($agents) if ($this.id == $member.agent_id) as $agent_match
        array.find ($addresses) if ($this.id == ($agent_match|get:"home_address_id":0)) as $address_match

        // Fallback: if no home address, use most recent transaction address
        var $fallback_address {
          value = null
        }

        conditional {
          if ($address_match == null && $agent_match != null) {
            // Find agent's most recent transaction
            array.find ($agent_transactions) if ($this.transaction_owner_agent_id == $agent_match.id) as $agent_tx

            conditional {
              if ($agent_tx != null) {
                // Get that transaction's address
                array.find ($tx_addresses) if ($this.id == $agent_tx.address_id) as $tx_addr

                var.update $fallback_address {
                  value = $tx_addr
                }
              }
            }
          }
        }

        // Use home address if available, otherwise fallback to transaction address
        var $final_address {
          value = $address_match != null ? $address_match : $fallback_address
        }

        var $enriched_member {
          value = $member
            |set:"name":($agent_match|get:"display_name":"")
            |set:"first_name":($agent_match|get:"first_name":"")
            |set:"last_name":($agent_match|get:"last_name":"")
            |set:"email":($agent_match|get:"email":"")
            |set:"phone":($agent_match|get:"phone":"")
            |set:"city":($final_address
              |get:"city":($agent_match|get:"city":"")
            )
            |set:"state":($final_address
              |get:"state_abbreviation":($final_address
                |get:"state":($agent_match|get:"state":"")
              )
            )
            |set:"state_province":($final_address
              |get:"state_abbreviation":($final_address
                |get:"state":($agent_match|get:"state":"")
              )
            )
            |set:"lat":($final_address|get:"lat":null)
            |set:"lng":($final_address|get:"long":null)
        }

        array.push $roster_data {
          value = $enriched_member
        }
      }
    }
  }

  response = $roster_data
  tags = [
    "ğŸ  dashboard"
    "ğŸ‘¥ team"
    "âœ¨ v2"
    "ğŸ”µ normalized-tables"
    "ğŸ“ location-fields-2025-12-22"
    "ğŸ”„ tx-address-fallback-2025-12-22"
  ]
}
