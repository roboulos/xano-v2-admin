# V1/V2 Complete Sync + Trust-Building Admin Dashboard

## Overview

The V2 system underwent a massive architectural transformation (251 JSONB tables → 196 normalized tables) but has a critical gap: **V1 and V2 are independent systems syncing from the same external APIs**. There is no V1→V2 replication pipeline. When V1 grows, V2 doesn't auto-sync.

**Root Cause:** V2 onboarding jobs only exist for 1 user (user_id: 72). Network/data sync SKIPS when no pending onboarding jobs exist.

**Current Data Gaps:**

- Users: ✅ Synced via test-sync endpoint (335 = 335)
- Network: ✅ Synced (V2 superset: 86,623 vs 86,617)
- Transactions: ❌ -2,596 behind V1
- Agents: ❌ -491 behind V1
- Participants: ❌ -29,175 behind V1
- FUB People: ❌ -87% (1.49M missing) - OUT OF SCOPE
- FUB Calls: ❌ -90% (4.89M missing) - OUT OF SCOPE

**Solution:** Build comprehensive V1→V2 sync that populates ALL normalized tables including the split tables (user→7 tables, agent→6 tables, transaction→5 tables, etc.), then build a trust-building admin dashboard.

## V1 → V2 Split Table Mappings

### User Domain (1 → 7 tables)

| V1 Table          | V2 Tables            | V2 IDs |
| ----------------- | -------------------- | ------ |
| `user` (mvpw1_41) | `user`               | 664    |
|                   | `user_credentials`   | 665    |
|                   | `user_subscriptions` | 666    |
|                   | `user_settings`      | 667    |
|                   | `user_roles`         | 668    |
|                   | `user_preferences`   | 711    |
|                   | `user_onboarding`    | 929    |

**Field Mapping (documented):**

- Core: id, email, first_name, last_name, cell_phone, avatar, active → user
- Auth: password, api_key, google_sub → user_credentials
- Billing: stripe_customer_id, subscription_type → user_subscriptions
- Settings: privacy_mode, daily_dash_daily → user_settings
- Roles: is_team_owner, is_leader, is_director, is_mentor → user_roles

### Agent Domain (1 → 6 tables)

| V1 Table | V2 Tables           | V2 IDs |
| -------- | ------------------- | ------ |
| `agent`  | `agent`             | 670    |
|          | `agent_cap_data`    | 671    |
|          | `agent_commission`  | 672    |
|          | `agent_performance` | 673    |
|          | `agent_hierarchy`   | 674    |
|          | `agent_rezen`       | 930    |

### Transaction Domain (1 → 5 tables)

| V1 Table      | V2 Tables                  | V2 IDs |
| ------------- | -------------------------- | ------ |
| `transaction` | `transaction`              | 675    |
|               | `transaction_participants` | 676    |
|               | `transaction_financials`   | 677    |
|               | `transaction_history`      | 678    |
|               | `transaction_tags`         | 679    |

### Network Domain (1 → 3 tables)

| V1 Table             | V2 Tables            | V2 IDs |
| -------------------- | -------------------- | ------ |
| `network` (mvpw1_48) | `network_member`     | 698    |
|                      | `network_hierarchy`  | 684    |
|                      | `network_user_prefs` | 690    |

## Scope

### In Scope

1. **Complete V1→V2 sync** including ALL split tables (not just main tables)
2. Sync all 21 V2 tables from their V1 sources
3. Build admin dashboard with "transformation story" view
4. Document migration scale
5. Real-time sync status monitoring
6. Prove data integrity through live verification

### Out of Scope

- **Continuous/scheduled sync** - manual trigger via endpoint only
- FUB historical backfill (1.49M records) - separate epic
- Demo data sync - not needed in V2
- Webhook forwarding from V1 to V2

## Approach

### Phase 1: Discovery & Field Mapping

Query V1 tables to extract all JSONB field names:

```sql
SELECT DISTINCT jsonb_object_keys(xdo) FROM mvpw1_XX LIMIT 1;
```

Then map each field to appropriate V2 split table.

### Phase 2: Build Comprehensive Sync

Extend endpoint 18027 with SQL for each V1→V2 mapping:

- User main table (already done)
- User split tables (credentials, subscriptions, settings, roles)
- Agent main + split tables
- Transaction main + split tables
- Network main + split tables
- Participant and participant_paid

### Phase 3: Build Trust Dashboard

- Transformation story tab showing 1→N splits
- Live record counts for ALL tables (main + split)
- Visual showing data flow from V1 JSONB to normalized V2

### Phase 4: Documentation

- Comprehensive sync guide
- Field mapping reference
- Monitoring and troubleshooting

## Architecture

```
┌──────────────────────────────────────────────────────────────────────┐
│                     V1 JSONB Tables                                   │
├──────────────────────────────────────────────────────────────────────┤
│  mvpw1_41 (user)     │  mvpw1_XX (agent)    │  mvpw1_XX (transaction)│
│  All fields in xdo   │  All fields in xdo   │  All fields in xdo     │
└──────────┬───────────┴──────────┬───────────┴──────────┬─────────────┘
           │                      │                      │
           │    CROSS-WORKSPACE SQL SYNC                 │
           │    Extract JSONB fields → Insert normalized │
           ▼                      ▼                      ▼
┌──────────────────────────────────────────────────────────────────────┐
│                     V2 Normalized Tables                              │
├──────────────────────────────────────────────────────────────────────┤
│  USER (7 tables)        │  AGENT (6 tables)     │  TXN (5 tables)    │
│  ├─ user (664)          │  ├─ agent (670)       │  ├─ transaction    │
│  ├─ user_credentials    │  ├─ agent_cap_data    │  ├─ txn_financials │
│  ├─ user_subscriptions  │  ├─ agent_commission  │  ├─ txn_history    │
│  ├─ user_settings       │  ├─ agent_performance │  ├─ txn_participants│
│  ├─ user_roles          │  ├─ agent_hierarchy   │  └─ txn_tags       │
│  ├─ user_preferences    │  └─ agent_rezen       │                    │
│  └─ user_onboarding     │                       │                    │
└──────────────────────────────────────────────────────────────────────┘
```

## Quick commands

```bash
# Verify current sync status
curl -s -X POST "https://x2nu-xcjc-vhax.agentdashboards.xano.io/api:20LTQtIX/test-sync" | jq

# Run dev server
pnpm dev
```

## Acceptance

- [ ] All V2 user tables populated (7 tables)
- [ ] All V2 agent tables populated (6 tables)
- [ ] All V2 transaction tables populated (5 tables)
- [ ] All V2 network tables populated (3 tables)
- [ ] Participant and participant_paid synced
- [ ] V2 main table counts within 5% of V1
- [ ] Admin dashboard shows transformation story with split table visualization
- [ ] Admin dashboard shows counts for ALL tables (main + split)
- [ ] `V2_SYNC_PIPELINE_GUIDE.md` documents complete field mapping
- [ ] Client can see the full scale of normalization work

## References

- **V1 Table IDs:** user=mvpw1_41, network=mvpw1_48, team=mvpw1_45
- **V2 Table IDs:** See mapping tables above
- **Field mappings:** V1_V2_TABLE_MAPPING.md lines 35-56 (user domain)
- **Existing sync endpoint:** `api:20LTQtIX/test-sync` (endpoint 18027)

## Dependencies

- **fn-2-riv**: V2 System Verification (validation infrastructure)
- **fn-4-tkb**: Xano V2 Admin Frontend Enhancement (dashboard)
