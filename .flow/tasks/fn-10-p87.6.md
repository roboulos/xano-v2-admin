# fn-10-p87.6 Discover V1 table IDs and extract JSONB field schemas

## Description

Discover all V1 table IDs and extract the complete JSONB field schema for each table that needs to be synced. This is the foundational discovery task that enables all subsequent sync tasks.

**Size:** M
**Files:**

- Xano MCP (direct SQL queries)
- `V1_V2_TABLE_MAPPING.md` (update with discovered IDs)

## Approach

### Step 1: List all V1 tables

```sql
SELECT table_name,
       (SELECT COUNT(*) FROM information_schema.columns c
        WHERE c.table_name = t.table_name) as col_count
FROM information_schema.tables t
WHERE table_schema = 'public'
  AND table_name LIKE 'mvpw1_%'
ORDER BY table_name;
```

### Step 2: Identify target tables

Find tables containing agents, transactions, participants by examining names and record counts.

### Step 3: Extract JSONB field names for each target table

```sql
SELECT DISTINCT jsonb_object_keys(xdo) as field
FROM mvpw1_XX
LIMIT 100;
```

### Step 4: Document field mapping

For each discovered table, create mapping document:

- V1 table ID
- All JSONB field names
- Proposed V2 table destination for each field
- Required type casts

### Step 5: Compare V2 schemas

```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'mvpw5_XXX';
```

## Key context

- Known V1 IDs: user=mvpw1_41, network=mvpw1_48, team=mvpw1_45
- V2 table IDs documented in V1_V2_TABLE_MAPPING.md
- User field mapping already documented (lines 35-56)
- Agent, transaction, network field mappings need discovery

## Deliverables

Output a JSON mapping file with:

```json
{
  "agent": {
    "v1_table": "mvpw1_XX",
    "fields": {
      "id": {"v2_table": "agent", "v2_column": "id", "cast": "none"},
      "cap_amount": {"v2_table": "agent_cap_data", "v2_column": "cap_amount", "cast": "numeric"},
      ...
    }
  },
  "transaction": {...},
  "participant": {...}
}
```

## Acceptance

- [x] All V1 tables listed with record counts
- [x] V1 agent table ID discovered and documented (mvpw1_36, 132 JSONB fields)
- [x] V1 transaction table ID discovered and documented (mvpw1_34, 119 JSONB fields)
- [x] V1 participant table ID discovered and documented (mvpw1_39, 30 JSONB fields)
- [x] All JSONB fields extracted for agent table (132 fields)
- [x] All JSONB fields extracted for transaction table (119 fields)
- [x] All JSONB fields extracted for participant table (30 fields)
- [x] Field-to-V2-table mapping documented for agent domain (5 V2 tables: 670-674)
- [x] Field-to-V2-table mapping documented for transaction domain (675)
- [x] V2 schema columns documented for verification
- [x] Mapping JSON file created: `.flow/V1_V2_FIELD_MAPPING.json`

## Done summary

Discovered all V1 table IDs and extracted complete JSONB schemas:

- **V1 Tables**: user (41), agent (36), transaction (34), participant (39), network (48)
- **Key Discovery**: V1 tables have only 2 PostgreSQL columns: `id` (bigint) + `xdo` (jsonb)
- **JSONB Extraction Pattern**: `xdo->>'field_name'` with type casting
- **Total Fields Mapped**: 449 fields across 5 domains
- **Sync Test**: user_credentials synced 335 records using direct SQL

## Evidence

- Files: `.flow/V1_V2_FIELD_MAPPING.json` (comprehensive mapping)
- Endpoint: 18569 `sync-v1-to-v2-direct` - working JSONB extraction pattern
- Curl Test: V1 (335 users) â†’ V2 (335 credentials) - sync verified
